<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lamp Login & Memory Challenge</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
    /* --- RESET & CORE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    
    body { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh;
        /* FIX: Dynamic viewport height for modern mobile browsers */
        min-height: 100dvh; 
        background-color: #1a1a1a; 
        overflow-y: auto; 
        overflow-x: hidden;
        user-select: none; 
        -webkit-tap-highlight-color: transparent;
    }

    .container { 
        position: relative; 
        display: flex; 
        /* FIX: Strictly centered layout (Middle) */
        align-items: center; 
        justify-content: center;
        gap: 20px; 
        padding: 20px;
        z-index: 1; 
        min-height: 100vh;
        min-height: 100dvh;
        width: 100%;
    }

    /* --- LAMP STYLES --- */
    .lamp-wrapper { position: relative; width: 220px; height: 500px; z-index: 10; display: flex; justify-content: center; align-items: flex-end; }
    .lamp-base { position: absolute; bottom: 0; width: 140px; height: 35px; background: #e0e0e0; border-radius: 50% 50% 10px 10px; z-index: 3; }
    .lamp-stand { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 12px; height: 220px; background: linear-gradient(to right, #996515, #ffd700, #996515); z-index: 2; }
    .lamp-head-wrapper { position: absolute; bottom: 230px; left: 50%; transform: translateX(-50%); width: 180px; height: 250px; z-index: 4; }
    .lamp-shade { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, #eaddcf, #fff8dc, #eaddcf); z-index: 5; }
    
    .lamp-string { 
        position: absolute; bottom: -80px; left: 50%; transform: translateX(-40px); 
        width: 4px; height: 80px; border-left: 3px dotted #b8860b; z-index: 1; cursor: pointer; 
    }
    /* Invisible larger click area for mobile */
    .lamp-string::before { content: ''; position: absolute; top: 0; left: -20px; width: 40px; height: 100%; z-index: 10; }
    .lamp-string::after { content: ''; position: absolute; bottom: -12px; left: -8px; width: 16px; height: 16px; background: radial-gradient(circle, #ffd700, #b8860b); border-radius: 50%; }

    .lamp-light { position: absolute; top: 240px; left: -20px; width: 220px; height: 300px; background: linear-gradient(to bottom, rgba(255, 223, 150, 0.5) 0%, rgba(255, 223, 150, 0) 80%); clip-path: polygon(20% 0, 80% 0, 100% 100%, 0% 100%); opacity: 0; transition: opacity 0.3s; z-index: 20; pointer-events: none; mix-blend-mode: screen; }
    
    .lamp-wrapper.active .lamp-shade { box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); background: #fffacd; }
    .lamp-wrapper.active .lamp-light { opacity: 1; }
    .pull-action { animation: pullString 0.4s ease-in-out; }
    @keyframes pullString { 50% { transform: translateX(-40px) translateY(15px); } }

    /* --- AUTH FORMS --- */
    .auth-container {
        position: relative; width: 350px; background: rgba(40, 40, 40, 0.95);
        border-radius: 10px; box-shadow: 0 15px 25px rgba(0,0,0,0.5); border: 1px solid #333;
        z-index: 5; opacity: 0; visibility: hidden; transform: translateY(20px);
        transition: all 0.4s ease; overflow: hidden; 
    }

    .auth-container.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .form-box { padding: 40px; display: none; }
    .form-box.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    h2 { margin: 0 0 30px; padding: 0; color: #fff; text-align: center; font-size: 24px; }
    .user-box { position: relative; margin-bottom: 30px; }
    .user-box input { width: 100%; padding: 10px 0; font-size: 16px; color: #fff; border: none; border-bottom: 1px solid #fff; outline: none; background: transparent; }
    .user-box label { position: absolute; top: 0; left: 0; padding: 10px 0; font-size: 16px; color: #fff; pointer-events: none; transition: .5s; }
    .user-box input:focus ~ label, .user-box input:valid ~ label { top: -20px; left: 0; color: #03e9f4; font-size: 12px; }
    .password-toggle { position: absolute; top: 5px; right: 0; cursor: pointer; filter: invert(1); opacity: 0.7; width: 20px; height: 20px; }
    .btn { position: relative; display: block; padding: 10px 20px; color: #03e9f4; font-size: 16px; text-transform: uppercase; letter-spacing: 4px; text-align: center; text-decoration: none; border: 1px solid #03e9f4; background: transparent; cursor: pointer; transition: .5s; width: 100%; margin-top: 20px; }
    .btn:hover { background: #03e9f4; color: #fff; box-shadow: 0 0 5px #03e9f4, 0 0 25px #03e9f4; }
    .toggle-text { margin-top: 15px; color: #fff; font-size: 12px; text-align: center; cursor: pointer; text-decoration: underline; }

    /* --- GAME OVERLAY & LAYOUT FIX --- */
    #gameOverlay, #leaderboardOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.95); z-index: 100;
        display: flex; flex-direction: column; 
        /* FIX: Ensure game is always centered */
        justify-content: center; 
        align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.5s;
        touch-action: none;
    }
    #gameOverlay.active, #leaderboardOverlay.active { opacity: 1; pointer-events: all; }
    
    .game-header { color: #fff; margin-bottom: 10px; text-align: center; width: 100%; padding: 0 10px; }
    .timer { font-size: 2rem; color: #ff4444; font-weight: bold; margin-bottom: 5px; }
    
    .memory-grid {
        display: grid; 
        grid-template-columns: repeat(8, 1fr); 
        gap: 4px; 
        width: 95vmin; 
        height: 95vmin; 
        max-width: 600px; 
        max-height: 600px;
    }

    .card { background-color: transparent; perspective: 1000px; cursor: pointer; border-radius: 4px; }
    
    /* --- ANDROID & iOS FIX FOR GLITCHES --- */
    .card-inner { 
        position: relative; 
        width: 100%; 
        height: 100%; 
        text-align: center; 
        transition: transform 0.6s; 
        transform-style: preserve-3d; 
        -webkit-transform-style: preserve-3d; /* Safari/Chrome Mobile Fix */
    }
    
    .card.flipped .card-inner { 
        transform: rotateY(180deg); 
        -webkit-transform: rotateY(180deg);
    }
    
    /* FIX: Don't use visibility:hidden. Use Opacity. Solves Black Hole issue */
    .card.matched .card-inner { 
        opacity: 0.3; 
        pointer-events: none;
    }
    
    .card-front, .card-back { 
        position: absolute; 
        width: 100%; 
        height: 100%; 
        backface-visibility: hidden; 
        -webkit-backface-visibility: hidden; /* Fix for Blue Blink glitch */
        display: flex; 
        justify-content: center; 
        align-items: center; 
        font-size: 1.5rem; 
        border-radius: 2px; 
        box-shadow: 0 0 2px rgba(3, 233, 244, 0.5); 
        /* Hardware acceleration to prevent glitches */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
    }
    
    .card-front { background-color: #222; border: 1px solid #333; }
    .card-back { background-color: #03e9f4; color: #000; transform: rotateY(180deg); -webkit-transform: rotateY(180deg); border: 1px solid #03e9f4; }

    /* LEADERBOARD STYLES */
    .leaderboard-box {
        background: #222; border: 1px solid #03e9f4;
        padding: 20px; border-radius: 10px;
        width: 90%; max-width: 400px; text-align: center;
        max-height: 80vh; overflow-y: auto;
    }
    .leaderboard-box h2 { color: #03e9f4; }
    .lb-table { width: 100%; margin-top: 10px; color: #fff; border-collapse: collapse; }
    .lb-table th, .lb-table td { padding: 8px; border-bottom: 1px solid #444; text-align: left; }
    .lb-table th { color: #aaa; font-size: 0.9em; }

    /* Message Box */
    #messageBox {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #fff; padding: 20px; border-radius: 10px; text-align: center;
        display: none; z-index: 200; box-shadow: 0 0 20px #000; width: 80%; max-width: 300px;
    }
    #messageBox h3 { color: #333; margin-bottom: 10px; }
    #messageBox button { margin-top: 10px; padding: 8px 16px; cursor: pointer; background: #333; color: #fff; border: none; border-radius: 4px; }

    @media (max-width: 600px) {
        .container { 
            /* Improved Mobile Layout Centering */
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding-top: 0; 
            padding-bottom: 0;
        }
        
        .lamp-wrapper { 
            transform: scale(0.65); 
            height: 350px; 
            /* Adjust margins to keep tight but centered */
            margin-bottom: -40px; 
            margin-top: -40px;
        }
        
        .auth-container { width: 90%; max-width: 350px; }
        .memory-grid { gap: 2px; width: 98vw; height: 98vw; }
        .card-front, .card-back { font-size: 0.9rem; border-width: 1px; }
    }
</style>
</head>
<body>

    <div class="container">
        <div class="lamp-wrapper" id="lamp">
            <div class="lamp-base"></div>
            <div class="lamp-stand"></div>
            <div class="lamp-head-wrapper">
                <div class="lamp-shade"></div>
                <div class="lamp-string" id="pullString"></div>
                <div class="lamp-light"></div>
            </div>
        </div>

        <div class="auth-container" id="authContainer">
            <div class="form-box active" id="loginForm">
                <h2>Login</h2>
                <form id="form-signin">
                    <div class="user-box">
                        <input type="email" id="li-email" required autocomplete="off">
                        <label>Email</label>
                    </div>
                    <div class="user-box">
                        <input type="password" id="li-password" required autocomplete="off">
                        <label>Password</label>
                        <img src="https://api.iconify.design/mdi:eye.svg" class="password-toggle" onclick="togglePassword('li-password')">
                    </div>
                    <button type="submit" class="btn">Start Challenge</button>
                    <div class="toggle-text" onclick="showSignUp()">New here? Create an account</div>
                </form>
            </div>

            <div class="form-box" id="signupForm">
                <h2>Sign Up</h2>
                <form id="form-signup">
                    <div class="user-box">
                        <input type="text" id="su-name" required autocomplete="off">
                        <label>Full Name</label>
                    </div>
                    <div class="user-box">
                        <input type="date" id="su-dob" required autocomplete="off" style="color:transparent" onfocus="this.style.color='#fff'" onblur="if(!this.value)this.style.color='transparent'">
                        <label>Date of Birth</label>
                    </div>
                    <div class="user-box">
                        <input type="tel" id="su-mobile" required autocomplete="off">
                        <label>Mobile Number</label>
                    </div>
                    <div class="user-box">
                        <input type="email" id="su-email" required autocomplete="off">
                        <label>Email</label>
                    </div>
                    <div class="user-box">
                        <input type="password" id="su-password" required autocomplete="off">
                        <label>Password</label>
                        <img src="https://api.iconify.design/mdi:eye.svg" class="password-toggle" onclick="togglePassword('su-password')">
                    </div>
                    <button type="submit" class="btn">Register</button>
                    <div class="toggle-text" onclick="showLogin()">Already have an account? Login</div>
                </form>
            </div>
        </div>
    </div>

    <div id="gameOverlay">
        <div class="game-header">
            <h2>Memory Game</h2>
            <p>Challenge yourself! Match all 32 pairs to show off your sharp memory and grab a reward <b><font color="red">1000 tk</font></b>!</p>
            <div class="timer" id="timer">5:00</div>
        </div>
        <div class="memory-grid" id="gameGrid"></div>
    </div>

    <div id="leaderboardOverlay">
        <div class="leaderboard-box">
            <h2>üèÜ Winners Board üèÜ</h2>
            <p>Recent Champions</p>
            <table class="lb-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="leaderboardList">
                    <tr><td colspan="2">Loading...</td></tr>
                </tbody>
            </table>
            <button class="btn" style="margin-top:20px; border-color:#fff; color:#fff;" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>

    <div id="messageBox">
        <h3 id="msgTitle">Title</h3>
        <p id="msgBody">Body</p>
        <button id="msgBtn" onclick="handleMsgBtn()">OK</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAGDV6rmZgUSxZUzgj_yI3K5xlUuZINbpI",
            authDomain: "memorychallange-3b80f.firebaseapp.com",
            projectId: "memorychallange-3b80f",
            storageBucket: "memorychallange-3b80f.firebasestorage.app",
            messagingSenderId: "572401506079",
            appId: "1:572401506079:web:96d5524cd58e7d31e6422a",
            measurementId: "G-LY1VR65NLV"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- UI VARS ---
        const lamp = document.getElementById('lamp');
        const pullString = document.getElementById('pullString');
        const authContainer = document.getElementById('authContainer');
        let isLampOn = false;

        // --- LAMP LOGIC ---
        pullString.addEventListener('click', () => {
            pullString.classList.add('pull-action');
            setTimeout(() => pullString.classList.remove('pull-action'), 400);
            
            isLampOn = !isLampOn;
            if (isLampOn) {
                lamp.classList.add('active');
                authContainer.classList.add('show');
            } else {
                lamp.classList.remove('active');
                authContainer.classList.remove('show');
            }
        });

        window.showSignUp = () => { document.getElementById('loginForm').classList.remove('active'); document.getElementById('signupForm').classList.add('active'); }
        window.showLogin = () => { document.getElementById('signupForm').classList.remove('active'); document.getElementById('loginForm').classList.add('active'); }
        window.togglePassword = (id) => { const x = document.getElementById(id); x.type = x.type === "password" ? "text" : "password"; }

        // --- AUTH ---
        document.getElementById('form-signup').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const cred = await auth.createUserWithEmailAndPassword(
                    document.getElementById('su-email').value,
                    document.getElementById('su-password').value
                );
                await db.collection('users').doc(cred.user.uid).set({
                    name: document.getElementById('su-name').value,
                    mobile: document.getElementById('su-mobile').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null
                });
                alert("Registered! Please Login.");
                showLogin();
                e.target.reset();
            } catch (err) { alert(err.message); }
        });

        let currentUserUid = null;
        let currentUserData = null;

        document.getElementById('form-signin').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const cred = await auth.signInWithEmailAndPassword(
                    document.getElementById('li-email').value,
                    document.getElementById('li-password').value
                );
                currentUserUid = cred.user.uid;
                const doc = await db.collection('users').doc(currentUserUid).get();
                if (!doc.exists) return alert("User missing");
                
                currentUserData = doc.data();

                if (currentUserData.lastLogin) {
                    const diff = (new Date() - currentUserData.lastLogin.toDate()) / (1000 * 60 * 60);
                    if (diff < 12) {
                        alert(`ACCESS DENIED. Wait ${(12 - diff).toFixed(1)} more hours.`);
                        auth.signOut();
                        return;
                    }
                }
                startGame();
            } catch (err) { alert("Login Failed: " + err.message); }
        });

        // --- GAME LOGIC ---
        const gameGrid = document.getElementById('gameGrid');
        const timerDisplay = document.getElementById('timer');
        let isGameActive = false, cards = [], hasFlippedCard = false, lockBoard = false;
        let firstCard, secondCard, matchedPairs = 0, timerInterval;
        let consecutiveWrong = 0; 
        let wrongGuessCards = new Set();
        let unflipTimeout = null, shuffleTimeout = null;
        const totalPairs = 32;

        const emojis = ['üöÄ','üåô','‚≠ê','üçé','üöó','üéà','üê±','üê∂','üê∏','üêº','üêØ','ü¶Å','‚öΩ','üèÄ','üéæ','üé±',
                        'üçï','üçî','üçü','üç¶','üç©','üç™','üç´','üç¨','üé®','üé≠','üé™','üé¢','üé°','üé¨','üé§','üéß'];

        function startGame() {
            if(unflipTimeout) clearTimeout(unflipTimeout);
            if(shuffleTimeout) clearTimeout(shuffleTimeout);

            isGameActive = true;
            document.getElementById('gameOverlay').classList.add('active');
            document.getElementById('messageBox').style.display = 'none';
            gameGrid.style.pointerEvents = 'auto';
            gameGrid.innerHTML = '';
            matchedPairs = 0;
            consecutiveWrong = 0;
            wrongGuessCards.clear();
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
            
            const deck = [...emojis, ...emojis];
            shuffle(deck);

            deck.forEach(emoji => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.innerHTML = `<div class="card-inner"><div class="card-front">?</div><div class="card-back">${emoji}</div></div>`;
                card.addEventListener('click', flipCard);
                gameGrid.appendChild(card);
            });

            startTimer(300); 
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function flipCard() {
            if (!isGameActive || lockBoard || this === firstCard || this.classList.contains('matched')) return;
            this.classList.add('flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true; firstCard = this; return;
            }
            secondCard = this;
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.querySelector('.card-back').innerText === secondCard.querySelector('.card-back').innerText;
            
            if (isMatch) {
                consecutiveWrong = 0;
                wrongGuessCards.clear();
                disableCards();
            } else {
                consecutiveWrong++; 
                wrongGuessCards.add(firstCard);
                wrongGuessCards.add(secondCard);
                unflipCards();
            }
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            
            setTimeout(() => { 
                if(!isGameActive) return;
                firstCard.classList.add('matched'); 
                secondCard.classList.add('matched'); 
            }, 500);
            
            matchedPairs++;
            resetBoard();
            if (matchedPairs === totalPairs) gameWon();
        }

        function unflipCards() {
            lockBoard = true;
            
            unflipTimeout = setTimeout(() => {
                if(!isGameActive) return;

                if (firstCard) firstCard.classList.remove('flipped');
                if (secondCard) secondCard.classList.remove('flipped');
                
                
                if (matchedPairs >= 22 && consecutiveWrong >= 3) {
                    shuffleTimeout = setTimeout(() => {
                         if(!isGameActive) return;
                        shuffleSpecificCards();
                        consecutiveWrong = 0;
                        wrongGuessCards.clear();
                        resetBoard(); 
                    }, 600); 
                } else {
                    resetBoard();
                }

            }, 1000);
        }

        function shuffleSpecificCards() {
            const cardsArray = Array.from(wrongGuessCards);
            const currentEmojis = cardsArray.map(c => c.querySelector('.card-back').innerText);
            shuffle(currentEmojis);

            cardsArray.forEach((card, index) => {
                card.querySelector('.card-back').innerText = currentEmojis[index];
                card.classList.remove('flipped'); 
            });
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function startTimer(duration) {
            let timer = duration;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m = parseInt(timer / 60, 10);
                let s = parseInt(timer % 60, 10);
                timerDisplay.textContent = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
                if (--timer < 0) gameLost();
            }, 1000);
        }

        async function gameWon() {
            clearInterval(timerInterval);
            isGameActive = false;
            
            try {
                const ts = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('users').doc(currentUserUid).update({ lastLogin: ts });
                await db.collection('game_winners').add({
                    name: currentUserData.name,
                    wonAt: ts
                });
                
                document.getElementById('gameOverlay').classList.remove('active');
                showLeaderboard(); 
            } catch (e) {
                console.error(e);
                alert("Won, but error saving data.");
            }
        }

        function gameLost() {
            clearInterval(timerInterval);
            if(unflipTimeout) clearTimeout(unflipTimeout);
            if(shuffleTimeout) clearTimeout(shuffleTimeout);
            
            isGameActive = false;
            gameGrid.style.pointerEvents = 'none';
            showMessage("Game Over", "Time ran out! Try again?", "RETRY");
        }

        async function showLeaderboard() {
            const overlay = document.getElementById('leaderboardOverlay');
            const tbody = document.getElementById('leaderboardList');
            overlay.classList.add('active');
            
            try {
                const snap = await db.collection('game_winners')
                    .orderBy('wonAt', 'desc')
                    .limit(10)
                    .get();
                
                tbody.innerHTML = '';
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="2">No winners yet!</td></tr>';
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    let dateStr = "Just now";
                    if(data.wonAt) dateStr = data.wonAt.toDate().toLocaleDateString();
                    
                    const row = `<tr><td>${data.name}</td><td>${dateStr}</td></tr>`;
                    tbody.innerHTML += row;
                });

            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="2">Error loading data</td></tr>';
            }
        }

        window.handleMsgBtn = function() {
            const btnText = document.getElementById('msgBtn').innerText;
            const box = document.getElementById('messageBox');
            
            if (btnText === "RETRY") {
                box.style.display = 'none';
                startGame();
            } else {
                box.style.display = 'none';
            }
        }

        function showMessage(title, body, btnText = "OK") {
            document.getElementById('msgTitle').innerText = title;
            document.getElementById('msgBody').innerText = body;
            document.getElementById('msgBtn').innerText = btnText;
            document.getElementById('messageBox').style.display = 'block';
        }
    });
    </script>
</body>
</html>
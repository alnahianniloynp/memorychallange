<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamp Login & Memory Challenge</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
    /* --- RESET & CORE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    
    body { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        background-color: #1a1a1a; 
        /* CHANGED: Allow scrolling on mobile if content is too tall */
        overflow-y: auto; 
        overflow-x: hidden;
        user-select: none; 
        /* Fix for mobile tap highlight color */
        -webkit-tap-highlight-color: transparent;
    }

    /* --- LAYOUT CONTAINER --- */
    .container { 
        position: relative; 
        display: flex; 
        align-items: flex-end; 
        gap: 20px; 
        padding-bottom: 50px; 
        z-index: 1; 
        /* Ensure container fits within view but allows scroll */
        min-height: 100vh;
        width: 100%;
        justify-content: center;
    }

    /* --- LAMP STYLES --- */
    .lamp-wrapper { position: relative; width: 220px; height: 500px; z-index: 10; display: flex; justify-content: center; align-items: flex-end; }
    .lamp-base { position: absolute; bottom: 0; width: 140px; height: 35px; background: #e0e0e0; border-radius: 50% 50% 10px 10px; z-index: 3; }
    .lamp-stand { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 12px; height: 220px; background: linear-gradient(to right, #996515, #ffd700, #996515); z-index: 2; }
    .lamp-head-wrapper { position: absolute; bottom: 230px; left: 50%; transform: translateX(-50%); width: 180px; height: 250px; z-index: 4; }
    .lamp-shade { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, #eaddcf, #fff8dc, #eaddcf); z-index: 5; }
    
    /* Touch target for string - made invisible area larger for easier tapping on mobile */
    .lamp-string { 
        position: absolute; bottom: -80px; left: 50%; transform: translateX(-40px); 
        width: 4px; height: 80px; border-left: 3px dotted #b8860b; z-index: 1; cursor: pointer; 
    }
    /* Add an invisible wider click area for the string */
    .lamp-string::before {
        content: ''; position: absolute; top: 0; left: -20px; width: 40px; height: 100%; z-index: 10;
    }
    .lamp-string::after { content: ''; position: absolute; bottom: -12px; left: -8px; width: 16px; height: 16px; background: radial-gradient(circle, #ffd700, #b8860b); border-radius: 50%; }

    .lamp-light { position: absolute; top: 240px; left: -20px; width: 220px; height: 300px; background: linear-gradient(to bottom, rgba(255, 223, 150, 0.5) 0%, rgba(255, 223, 150, 0) 80%); clip-path: polygon(20% 0, 80% 0, 100% 100%, 0% 100%); opacity: 0; transition: opacity 0.3s; z-index: 20; pointer-events: none; mix-blend-mode: screen; }
    
    .lamp-wrapper.active .lamp-shade { box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); background: #fffacd; }
    .lamp-wrapper.active .lamp-light { opacity: 1; }
    .pull-action { animation: pullString 0.4s ease-in-out; }
    @keyframes pullString { 50% { transform: translateX(-40px) translateY(15px); } }

    /* --- AUTH FORMS --- */
    .auth-container {
        position: relative; width: 350px; background: rgba(40, 40, 40, 0.95);
        border-radius: 10px; box-shadow: 0 15px 25px rgba(0,0,0,0.5); border: 1px solid #333;
        z-index: 5; opacity: 0; visibility: hidden; transform: translateY(20px);
        transition: all 0.4s ease; overflow: hidden;
        /* Ensure form doesn't get cut off on small screens */
        margin-bottom: 20px; 
    }

    .auth-container.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .form-box { padding: 40px; display: none; }
    .form-box.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    h2 { margin: 0 0 30px; padding: 0; color: #fff; text-align: center; font-size: 24px; }
    .user-box { position: relative; margin-bottom: 30px; }
    .user-box input { width: 100%; padding: 10px 0; font-size: 16px; color: #fff; border: none; border-bottom: 1px solid #fff; outline: none; background: transparent; }
    .user-box label { position: absolute; top: 0; left: 0; padding: 10px 0; font-size: 16px; color: #fff; pointer-events: none; transition: .5s; }
    .user-box input:focus ~ label, .user-box input:valid ~ label { top: -20px; left: 0; color: #03e9f4; font-size: 12px; }

    /* Password Toggle Icon */
    .password-toggle { position: absolute; top: 5px; right: 0; cursor: pointer; filter: invert(1); opacity: 0.7; width: 20px; height: 20px; }
    .password-toggle:hover { opacity: 1; }

    .btn { position: relative; display: block; padding: 10px 20px; color: #03e9f4; font-size: 16px; text-transform: uppercase; letter-spacing: 4px; text-align: center; text-decoration: none; border: 1px solid #03e9f4; background: transparent; cursor: pointer; transition: .5s; width: 100%; margin-top: 20px; }
    .btn:hover { background: #03e9f4; color: #fff; box-shadow: 0 0 5px #03e9f4, 0 0 25px #03e9f4; }
    .toggle-text { margin-top: 15px; color: #fff; font-size: 12px; text-align: center; cursor: pointer; text-decoration: underline; }
    .toggle-text:hover { color: #03e9f4; }

    /* --- GAME OVERLAY --- */
    #gameOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.95); z-index: 100;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.5s;
        /* Prevent scroll on body when game is open */
        touch-action: none;
    }
    #gameOverlay.active { opacity: 1; pointer-events: all; }
    
    .game-header { color: #fff; margin-bottom: 10px; text-align: center; width: 100%; padding: 0 10px; }
    .timer { font-size: 2rem; color: #ff4444; font-weight: bold; margin-bottom: 5px; }
    
    .memory-grid {
        display: grid; 
        grid-template-columns: repeat(8, 1fr); 
        gap: 4px; /* Default gap */
        width: 95vmin; /* Use almost full viewport min-dimension */
        height: 95vmin; 
        max-width: 600px; 
        max-height: 600px;
    }

    .card { background-color: transparent; perspective: 1000px; cursor: pointer; border-radius: 4px; }
    .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card.matched { visibility: hidden; pointer-events: none; }
    
    .card-front, .card-back { 
        position: absolute; width: 100%; height: 100%; 
        backface-visibility: hidden; display: flex; justify-content: center; align-items: center; 
        font-size: 1.5rem; /* Default size */
        border-radius: 2px; /* Smaller radius for tight grid */
        box-shadow: 0 0 2px rgba(3, 233, 244, 0.5); 
    }
    .card-front { background-color: #222; border: 1px solid #333; }
    .card-back { background-color: #03e9f4; color: #000; transform: rotateY(180deg); border: 1px solid #03e9f4; }

    /* Message Box */
    #messageBox {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #fff; padding: 20px; border-radius: 10px; text-align: center;
        display: none; z-index: 200; box-shadow: 0 0 20px #000; width: 80%; max-width: 300px;
    }
    #messageBox h3 { color: #333; margin-bottom: 10px; }
    #messageBox button { margin-top: 10px; padding: 8px 16px; cursor: pointer; background: #333; color: #fff; border: none; border-radius: 4px; }

    /* --- MOBILE OPTIMIZATION --- */
    @media (max-width: 600px) {
        .container {
            flex-direction: column; /* Stack Lamp on top of Form */
            align-items: center;
            justify-content: flex-start; /* Start from top */
            padding-top: 20px;
            padding-bottom: 100px; /* Space for scrolling past form */
        }
        
        .lamp-wrapper {
            transform: scale(0.65); /* Shrink lamp significantly */
            height: 350px; /* Reduce visual height space */
            margin-bottom: -50px; /* Pull form up closer to lamp */
        }

        .auth-container {
            width: 90%; /* Responsive width */
            max-width: 350px;
        }

        /* Adjust Grid for tiny screens */
        .memory-grid {
            gap: 2px; /* Tiny gap to maximize card size */
            width: 98vw; /* Use full width */
            height: 98vw; /* Keep it square */
        }
        
        .card-front, .card-back {
            font-size: 0.9rem; /* Smaller emoji font */
            border-width: 1px;
        }
    }
</style>
</head>
<body>

    <div class="container">
        <div class="lamp-wrapper" id="lamp">
            <div class="lamp-base"></div>
            <div class="lamp-stand"></div>
            <div class="lamp-head-wrapper">
                <div class="lamp-shade"></div>
                <div class="lamp-string" id="pullString"></div>
                <div class="lamp-light"></div>
            </div>
        </div>

        <div class="auth-container" id="authContainer">
            
            <div class="form-box active" id="loginForm">
                <h2>Login</h2>
                <form id="form-signin">
                    <div class="user-box">
                        <input type="email" id="li-email" required autocomplete="off">
                        <label>Email</label>
                    </div>
                    <div class="user-box">
                        <input type="password" id="li-password" required autocomplete="off">
                        <label>Password</label>
                        <img src="https://api.iconify.design/mdi:eye.svg" class="password-toggle" onclick="togglePassword('li-password')">
                    </div>
                    <button type="submit" class="btn">Start Challenge</button>
                    <div class="toggle-text" onclick="showSignUp()">New here? Create an account</div>
                </form>
            </div>

            <div class="form-box" id="signupForm">
                <h2>Sign Up</h2>
                <form id="form-signup">
                    <div class="user-box">
                        <input type="text" id="su-name" required autocomplete="off">
                        <label>Full Name</label>
                    </div>
                    <div class="user-box">
                        <input type="date" id="su-dob" required autocomplete="off" style="color:transparent" onfocus="this.style.color='#fff'" onblur="if(!this.value)this.style.color='transparent'">
                        <label>Date of Birth</label>
                    </div>
                    <div class="user-box">
                        <input type="tel" id="su-mobile" required autocomplete="off">
                        <label>Mobile Number</label>
                    </div>
                    <div class="user-box">
                        <input type="email" id="su-email" required autocomplete="off">
                        <label>Email</label>
                    </div>
                    <div class="user-box">
                        <input type="password" id="su-password" required autocomplete="off">
                        <label>Password</label>
                        <img src="https://api.iconify.design/mdi:eye.svg" class="password-toggle" onclick="togglePassword('su-password')">
                    </div>
                    <button type="submit" class="btn">Register</button>
                    <div class="toggle-text" onclick="showLogin()">Already have an account? Login</div>
                </form>
            </div>
        </div>
    </div>

    <div id="gameOverlay">
        <div class="game-header">
            <h2>Memory Game</h2>
            <p>Challenge yourself! Match all 32 pairs to show off your sharp memory and grab a reward!</p>
            <div class="timer" id="timer">5:00</div>
        </div>
        <div class="memory-grid" id="gameGrid"></div>
    </div>

    <div id="messageBox">
        <h3 id="msgTitle">Title</h3>
        <p id="msgBody">Body</p>
        <button onclick="location.reload()">OK</button>
    </div>

    <script>
        // ==========================================
        // 1. FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
        apiKey: "AIzaSyAGDV6rmZgUSxZUzgj_yI3K5xlUuZINbpI",
        authDomain: "memorychallange-3b80f.firebaseapp.com",
        projectId: "memorychallange-3b80f",
        storageBucket: "memorychallange-3b80f.firebasestorage.app",
        messagingSenderId: "572401506079",
        appId: "1:572401506079:web:96d5524cd58e7d31e6422a",
        measurementId: "G-LY1VR65NLV"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==========================================
        // 2. UI UTILITIES
        // ==========================================
        const lamp = document.getElementById('lamp');
        const pullString = document.getElementById('pullString');
        const authContainer = document.getElementById('authContainer');
        let isLampOn = false;

        // Lamp Toggle
        pullString.addEventListener('click', () => {
            pullString.classList.add('pull-action');
            setTimeout(() => pullString.classList.remove('pull-action'), 400);
            
            isLampOn = !isLampOn;
            if (isLampOn) {
                lamp.classList.add('active');
                authContainer.classList.add('show');
            } else {
                lamp.classList.remove('active');
                authContainer.classList.remove('show');
            }
        });

        function showSignUp() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('signupForm').classList.add('active');
        }
        function showLogin() {
            document.getElementById('signupForm').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
        }

        // --- NEW: PASSWORD TOGGLE FUNCTION ---
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
            } else {
                input.type = "password";
            }
        }

        // ==========================================
        // 3. AUTHENTICATION & RESTRICTION
        // ==========================================
        
        // SIGN UP
        document.getElementById('form-signup').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('su-email').value;
            const pass = document.getElementById('su-password').value;
            const name = document.getElementById('su-name').value;
            const dob = document.getElementById('su-dob').value;
            const mobile = document.getElementById('su-mobile').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name, dob: dob, mobile: mobile, email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null // Initialize as null
                });

                alert("Registration Successful! Please Login.");
                showLogin();
                document.getElementById('form-signup').reset();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        // SIGN IN WITH 12-HOUR CHECK
        let currentUserUid = null;
        let currentUserData = null;

        document.getElementById('form-signin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('li-email').value;
            const pass = document.getElementById('li-password').value;

            try {
                // 1. Verify Credentials
                const userCredential = await auth.signInWithEmailAndPassword(email, pass);
                currentUserUid = userCredential.user.uid;

                // 2. Fetch User Data
                const userDoc = await db.collection('users').doc(currentUserUid).get();
                if (!userDoc.exists) {
                    alert("User record missing.");
                    return;
                }

                currentUserData = userDoc.data();

                // 3. --- CHECK 12 HOUR RESTRICTION ---
                if (currentUserData.lastLogin) {
                    const lastLoginDate = currentUserData.lastLogin.toDate();
                    const now = new Date();
                    const diffMs = now - lastLoginDate;
                    const hoursPassed = diffMs / (1000 * 60 * 60);

                    if (hoursPassed < 12) {
                        const remaining = (12 - hoursPassed).toFixed(1);
                        alert(`ACCESS DENIED. \n\nYou last accessed the system ${hoursPassed.toFixed(1)} hours ago.\nYou must wait ${remaining} more hours.`);
                        auth.signOut(); // Log them out
                        return; // STOP HERE
                    }
                }

                // 4. If > 12 hours or first time, start game
                startGame();

            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        });

        // ==========================================
        // 4. GAME LOGIC
        // ==========================================
        const gameGrid = document.getElementById('gameGrid');
        const timerDisplay = document.getElementById('timer');
        const overlay = document.getElementById('gameOverlay');
        
        let cards = [], hasFlippedCard = false, lockBoard = false;
        let firstCard, secondCard, matchedPairs = 0, timerInterval;
        const totalPairs = 32; 

        const emojis = ['ðŸš€','ðŸŒ™','â­','ðŸŽ','ðŸš—','ðŸŽˆ','ðŸ±','ðŸ¶','ðŸ¸','ðŸ¼','ðŸ¯','ðŸ¦','âš½','ðŸ€','ðŸŽ¾','ðŸŽ±',
                        'ðŸ•','ðŸ”','ðŸŸ','ðŸ¦','ðŸ©','ðŸª','ðŸ«','ðŸ¬','ðŸŽ¨','ðŸŽ­','ðŸŽª','ðŸŽ¢','ðŸŽ¡','ðŸŽ¬','ðŸŽ¤','ðŸŽ§'];

        function startGame() {
            overlay.classList.add('active');
            gameGrid.innerHTML = '';
            matchedPairs = 0;
            
            const deck = [...emojis, ...emojis];
            shuffle(deck);

            deck.forEach(emoji => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.innerHTML = `<div class="card-inner"><div class="card-front">?</div><div class="card-back">${emoji}</div></div>`;
                card.addEventListener('click', flipCard);
                gameGrid.appendChild(card);
            });

            startTimer(300);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function flipCard() {
            if (lockBoard || this === firstCard) return;
            this.classList.add('flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true; firstCard = this; return;
            }
            secondCard = this;
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.querySelector('.card-back').innerText === secondCard.querySelector('.card-back').innerText;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            setTimeout(() => { firstCard.style.visibility = "hidden"; secondCard.style.visibility = "hidden"; }, 500);
            matchedPairs++;
            resetBoard();
            if (matchedPairs === totalPairs) gameWon();
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function startTimer(duration) {
            let timer = duration;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerDisplay.textContent = minutes + ":" + seconds;
                if (--timer < 0) gameLost();
            }, 1000);
        }

        // ==========================================
        // 5. GAME OUTCOMES & DB UPDATE
        // ==========================================
        
        async function gameWon() {
            clearInterval(timerInterval);
            
            try {
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                // 1. Log Winner
                await db.collection('game_winners').add({
                    name: currentUserData.name,
                    mobile: currentUserData.mobile,
                    wonAt: timestamp
                });

                // 2. UPDATE USER LAST LOGIN (Starts 12h timer)
                await db.collection('users').doc(currentUserUid).update({
                    lastLogin: timestamp
                });
                
                showMessage("Login Successful", "Security check passed. Access Granted.");
            } catch (e) {
                console.error(e);
                showMessage("Error", "Could not save data, but you won.");
            }
        }

        function gameLost() {
            clearInterval(timerInterval);
            showMessage("Game Over", "Time ran out.");
            auth.signOut(); 
        }

        function showMessage(title, body) {
            document.getElementById('msgTitle').innerText = title;
            document.getElementById('msgBody').innerText = body;
            document.getElementById('messageBox').style.display = 'block';
        }
    </script>
</body>
</html>